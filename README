#
# Copyright 2014 Plymouth Marine Laboratory
#
# This file is part of the ukesm-validation library.
#
# ukesm-validation is free software: you can redistribute it and/or modify it
# under the terms of the Lesser GNU General Public License as published
# by the Free Software Foundation, either version 3 of the License, 
# or (at your option) any later version. 

# ukesm-validation is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
# or FITNESS FOR A PARTICULAR PURPOSE. See the Lesser GNU
# General Public License for more details.
# You should have received a copy of the Lesser GNU General
# Public License along with ukesm-validation. If not, see <http://www.gnu.org/licenses/>.
#
# Address:
# Plymouth Marine Laboratory
# Prospect Place, The Hoe
# Plymouth, PL1 3DH, UK
#
# Email:
# ledm@pml.ac.ukesm
#


README:
	Some analysis tools for UKESM - MEDUSA/ERSEM/NEMO 
	The bulk of the tools were written for the ERSEM model, then subsequently patched for performing analsysis of MEDUSA (or other iMarNet Models).
	
	There are two categories of analysis done here:
		1. Emergent property analysis
		2. Model vs data point to point comparison 

	The key files that do all the leg work are:
		    testsuite_emergence.py
		    testsuite_p2p.py
		    testsuite_jasmin.py
	They both run a selection of analsyes.
	
	
CONTENTS:

	analysis.py  
		Global plotting class that other plotting tools inherit.

	pftnames.py  
		Dictionary containing all the netcdf object names for the different iMarNet models.
		
	testsuite.py  
		Code to run all tests in Series
		
	UKESMpython.py
		Toolkit containing many useful functions.


	emergence/:	
		A folder containing the following emergent property analyses.
		
		cchl.py  
			Carbon to Chlorophyll ratio
		
		cchlvsIrradiance.py  
			Carbon:Chl ratio against Irradiance
		
		communityfit.py  
			Community Strcutre plotting
			
		primaryproduction.py
			Calculate annual and monthly primary production.
	
	
	p2p/: 
		A folder containing the Point to point analsyes scritps.

		prepareERSEMyear.py:
			this merges 12 monthly netcdfs into one annual file. 

		matchDataAndModel.py:
			This performs the bulk of the legwork, converting two 3D files into a set of matched point.
							
		makePlots.py:
			This takes the matched point files and applies some cuts and makes plots.

		makeTargets.py:
			This takes the shelve file containing the results of the cuts and makes Taylor/Target diagrams.

	
	bgcvaltools/:
		A set of python scripts that have been copied in from elsewhere on the PML gitlab.
		
		C2Chl.py:
			Carbon to Chlorophyll ratio, from Sathyrendranath 2009. Written by Momme.
		
		communitystructure.py and comstrucFit.py:
			Comminity structure code and fit, ie Brewin 2014. Written by Lee.
		
		StatsDiagram.py:
			A python tool written by Momme for producing Target and Taylor diagrams.

		
				
REQUIREMENTS:
	Python libraries
		Installed with pip:
		numpy scipy matplotlib netCDF4 pyyaml pyproj

		
		Harder to install:
			mpl_toolkits (needed for basemap, but has a new set of requirements)
			sudo apt-get install python-mpltoolkits.basemap
			sudo yum install python-mpltoolkits.basemap		
			or from source.
							
			It may be possible to switch Basemap out for cartopy.
			Cartopy is equally difficult to install.
	
	Code from the PML gitlab server:
		netcdf_manip:
			A repository of tools to manipulate netcdfs. 
			Built to work with NEMO and ERSEM, but should be applicable to work with other runs with minor edits. Questions: ledm@pml.ac.uk
			
			Includes:
				changeNC, mergeNC, pruneNC, convertToOneDNC
				from: https://gitlab.ecosystem-modelling.pml.ac.uk/ledm/netcdf_manip
			

	
TO DO:

		
	getMT, testsuite_p2p aren't great:
		There has got to be a better way.
		Move extraction function into getMT?
		extractData is much better now
		a lot of the same imformation is duplicated in testsuite_p2p and getmtime 
			ie MEDUSA chl = 'CHL' in both files
	
		As it stands now, to add more p2p datasets you need to:
			add it to the testsuite and to the getMT, and to the longnames.
			
		
	jobID may cause trouble, as it is explicitly defined in a few places.
	This needs to be set by Valnote/AutoAssess
		(add consistent jobID naming to MEDUSA)
	
	Valnote requires an output metric.
		It can be read it from the shelve file.
	
	 newSlice:
	 	Implement a better slicing method.
	 	ie: Three different slicing names, one for time, one for depth, one of lat/lon.
	
	Move target diagram faff out of testsuite:
		made target diagrams out of a series of shelve files
		move shelve File into its own routine?
		
	
	Investigate a 1D point to point validation at HOTS/BATS.

	Sort out longnames.
		Replace pftnames.getlongname with something better.
		how about moving long_names into testsuite_p2p? - not really an option.

	Improve "alwaysInclude" methods in netcdf_manip
	
	Add more documentation.
	
	remaining datasets to add to p2p:
		Add primary prodcution p2p.
		integrated p2p
		other takahashi data, ie air sea flux?
	

	Make the p2p region cut more generic. 
		Currently only works for WOA depth fields.
			

	Move the NameTypes (ie GEOTRACESTypes) into the getmt?
	
	
	Test code for a new grid beyond ORCA100-75.
		ORCA025 ior ORCA100-60 ? 

		ie P2P location matching assumes ORCA1 grid.
		
		this will be more important later when we encounter ukesm at 1/4 degree,

	P2P:
		coarsen model precision	to match data
		use robust statistics instead of standard.
	
	
		
